
service: flutter-aws-serverless
frameworkVersion: '2'

provider:
  name: aws
  runtime: nodejs12.x
  region: us-east-1
  stage: dev
  profile: taehoon-flutter-study
  logs:
    websocket: true
  environment:
    TABLE_NAME: flutter-chat-tbl
  iamRoleStatements:
    - Effect: "Allow"
      Action:
          - dynamodb:DescribeTable
          - dynamodb:Query
          - dynamodb:Scan
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${self:provider.region}:*:*"

 
functions:
  # Web sockets handlers
  connectionHandler:
    handler: handler.connectionHandler
    events:
      - websocket:
          route: $connect
      - websocket:
          route: $disconnect
  defaultHandler:
    handler: handler.defaultHandler
    events:
      - websocket: $default
  databaseStreamHandler:
    handler: handler.databaseStreamHandler
    events:
      - websocket:
          route: databaseStream
  # DynamoDB Stream Handler
  chatTableStreamHandler:
    handler: handler.chatTableStreamHandler
    events:
      - stream:
          type: dynamodb
          batchSize: 1
          startingPosition: LATEST
          arn:
            Fn::GetAtt: [flutterChatTable, StreamArn]
  # CONNECTED collection CRUD
  testerFunction:
    handler: handler.testerFunction
    events:
      - http:
          path: ${self:service}/test/testerFunction
          method: post
          cors: true
          integration: lambda
          request:
            template:
              application/json: >
                #set($inputRoot = $input.path('$'))
                {
                  "num1": $inputRoot.input.operand1,
                  "num2": $inputRoot.input.operand2
                }
          response:
            headers:
              Access-Control-Allow-Origin: "'*'"
              Content-Type: "'application/json'"
            template: ${file(templates/template_default_response.txt)}

  createConnected:
    handler: handler.createConnected
    events:
      - http:
          path: ${self:service}/connected/createConnected
          method: get
  createConnectedUser:
    handler: handler.createConnectedUser
    events:
      - http:
          path: ${self:service}/connected/createConnectedUser
          method: post
          cors: true
          integration: lambda
          request:
            template:
              application/json: ${file(templates/template_connected_user_request.txt)}
            schema:
              application/json: ${file(schemaValidators/schema_connected_user_request.json)}
          response:
            headers:
              Access-Control-Allow-Origin: "'*'"
              Content-Type: "'application/json'"
            template: ${file(templates/template_default_response.txt)}
  getConnected:
    handler: handler.getConnected
    events:
      - http:
          path: ${self:service}/connected/getConnected
          method: get
          integration: lambda
          response:
            headers:
              Access-Control-Allow-Origin: "'*'"
              Content-Type: "'application/json'"
            template: ${file(templates/template_default_response.txt)}
  getConnectedUser:
    handler: handler.getConnectedUser
    events:
      - http:
          path: ${self:service}/connected/getConnectedUser
          method: get
          integration: lambda
          request:
            template:
              application/json: >
                {
                  "userName": "$input.params('userName')"
                }
          response:
            headers:
              Access-Control-Allow-Origin: "'*'"
              Content-Type: "'application/json'"
            template: ${file(templates/template_default_response.txt)}
  updateConnected:
    handler: handler.updateConnected
    events:
      - http:
          path: ${self:service}/connected/updateConnected
          method: post
          cors: true
          integration: lambda
          request:
            template:
              application/json: ${file(templates/template_connected_user_request.txt)}
            schema:
              application/json: ${file(schemaValidators/schema_connected_user_request.json)}
          response:
            headers:
              Access-Control-Allow-Origin: "'*'"
              Content-Type: "'application/json'"
            template: ${file(templates/template_default_response.txt)}
  deleteConnected:
    handler: handler.deleteConnected
    events:
      - http:
          path: ${self:service}/connected/deleteConnected    
          method: get
          integration: lambda
          request:
            template:
              application/json: >
                {
                  "userName": "$input.params('userName')"
                }
          response:
            headers:
              Access-Control-Allow-Origin: "'*'"
              Content-Type: "'application/json'"
            template: ${file(templates/template_default_response.txt)}
          
  # MSG Collection CRUD
  createMessage:
    handler: handler.createMessage
    events:
      - http:
          path: ${self:service}/messages/createMessage
          method: post
          cors: true      
  getMessage:
    handler: handler.getMessage
    events:
      - http:
          path: ${self:service}/messages/getMessage
          method: get      
  updateMessage:
    handler: handler.updateMessage
    events:
      - http:
          path: ${self:service}/messages/updateMessage
          method: post

resources:
  Resources:
    flutterChatTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: flutter-chat-tbl
        AttributeDefinitions:
          - AttributeName: collection
            AttributeType: S  
          - AttributeName: subCollection
            AttributeType: S
        KeySchema:
          - AttributeName: collection
            KeyType: HASH   # Partition Key
          - AttributeName: subCollection
            KeyType: RANGE  # Sort key
        ProvisionedThroughput:
          ReadCapacityUnits: 10
          WriteCapacityUnits: 10
        StreamSpecification:
          StreamViewType: NEW_IMAGE
          